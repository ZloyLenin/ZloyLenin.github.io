<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/variables.css" />
  <link rel="stylesheet" href="css/account.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script type="module" src="scripts/style.js"></script>
</head>
<body id="accountRoot" class="fantasy-root">
  <header class="universal-header">
    <div class="logo" id="mainLogo" style="font-size:2em;font-weight:600;cursor:pointer;">GeekGang</div>
    <div class="header-controls">
      <button class="view-btn fantasy-btn" onclick="window.location.href='index.html'" title="–ù–∞ –≥–ª–∞–≤–Ω—É—é">
        <i class="fa-solid fa-arrow-left"></i>
        <span>–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
      </button>
      <button class="view-btn fantasy-btn" id="settingsButton" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
        <i class="fa-solid fa-cog"></i>
      </button>
    </div>
  </header>
  <main class="fantasy-main-content">
    <div class="fantasy-main-grid" style="justify-content:center;">
      <div class="fantasy-board-card fantasy-profile-card">
        <div class="fantasy-profile-avatar">
          <label class="avatar-label">
            <input type="file" id="avatarInput" accept="image/*" style="display: none;">
            <img id="avatarImg" src="" alt="–ê–≤–∞—Ç–∞—Ä" style="display:none;" />
            <span class="avatar-stub"><i class="fa-solid fa-user"></i></span>
          </label>
        </div>
        <div class="fantasy-profile-info">
          <div class="fantasy-profile-name" id="userName">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
          <div class="fantasy-profile-email" id="userEmail">user@example.com</div>
          <div class="fantasy-profile-created" id="userCreated">–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω: ‚Äî</div>
        </div>
      </div>
    </div>
  </main>
  <button class="fantasy-fab-dice fantasy-btn" id="diceFabBtn" title="–ë—Ä–æ—Å–∏—Ç—å –¥–∞–π—Å—ã">
    <i class="fa-solid fa-dice-d20"></i>
  </button>
  <div class="fantasy-bottom-controls">
    <button id="themeToggleBtn" class="theme-toggle fantasy-btn" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
      <span class="theme-icon"></span>
    </button>
  </div>
  <div class="fantasy-modal" id="settingsModal">
    <div class="fantasy-modal-content" id="settingsMainPage">
      <button class="fantasy-modal-close" id="modalClose">&times;</button>
      <h2 class="fantasy-profile-name">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
      <div class="fantasy-profile-email">–í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º –∏–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∞–∫–∫–∞—É–Ω—Ç–æ–º.</div>
      <div style="margin-top:24px; text-align:center; display:flex; flex-direction:column; gap:16px;">
        <button class="fantasy-btn" id="changeNickBtn">
          <i class="fa-solid fa-pen"></i> –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º
        </button>
        <button class="fantasy-btn" id="accountManageBtn">
          <i class="fa-solid fa-user-gear"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º
        </button>
      </div>
    </div>
    <div class="fantasy-modal-content" id="changeNicknamePage" style="display:flex; flex-direction:column; gap:16px;">
      <button class="fantasy-modal-close" id="modalCloseNick">&times;</button>
      <h2 class="fantasy-profile-name">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∏–∫–Ω–µ–π–º–∞</h2>
      <div class="fantasy-profile-email">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º:</div>
      <form id="modalProfileForm" class="fantasy-profile-form" >
        <input type="text" id="modalNicknameInput" class="fantasy-form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º" maxlength="20">
        <button type="submit" class="fantasy-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫</button>
        <div class="fantasy-save-msg" id="modalSaveMsg">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</div>
      </form>
      <button class="fantasy-btn" id="backToSettingsNickBtn">‚Üê –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º</button>
    </div>
    <div class="fantasy-modal-content" id="accountManagePage" style="display:flex; flex-direction:column; gap:16px;">
      <button class="fantasy-modal-close" id="modalClose2">&times;</button>
      <h2 class="fantasy-profile-name">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º</h2>
      <div class="fantasy-profile-email">–ó–¥–µ—Å—å –æ–ø—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞—à–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º.</div>
      <div style="text-align:center; display:flex; flex-direction:column; gap:16px;">
        <button class="fantasy-btn" id="logoutBtn">
          <i class="fa-solid fa-right-from-bracket"></i> –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
        </button>
        <button class="fantasy-btn" id="deleteAccountBtn">
          <i class="fa-solid fa-user-minus"></i> –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
        </button>
      </div>
      <button class="fantasy-btn" id="backToSettingsBtn">‚Üê –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º</button>
    </div>
  </div>
<script type="module" src="scripts/style.js"></script>
<script type="module" src="scripts/theme.js"></script>
<script type="module">
  import { initStyle, setStyle } from './scripts/style.js';
  import { initTheme } from './scripts/theme.js';
  import { loadUserProfile, logout } from './scripts/auth.js';

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ –≤ localStorage
  function saveAvatarToStorage(imageData) {
    localStorage.setItem('userAvatar', imageData);
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ –∏–∑ localStorage
  function loadAvatarFromStorage() {
    const avatarData = localStorage.getItem('userAvatar');
    if (avatarData) {
      const avatarImg = document.getElementById('avatarImg');
      avatarImg.src = avatarData;
      avatarImg.style.display = 'block';
      document.querySelector('.avatar-stub').style.display = 'none';
    }
  }

  window.addEventListener('DOMContentLoaded', async () => {
    // Initialize theme and style
    initTheme();
    initStyle();
    
    const user = await loadUserProfile();
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    if (!user) return;
    // –î–∞–Ω–Ω—ã–µ —É–∂–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ loadUserProfile, –Ω–æ –º–æ–∂–Ω–æ –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å:
    if (user.username) document.getElementById('userName').textContent = user.username;
    if (user.email) document.getElementById('userEmail').textContent = user.email;
    if (user.created) document.getElementById('userCreated').textContent = `–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω: ${new Date(user.created).toLocaleDateString()}`;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∞–≤–∞—Ç–∞—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadAvatarFromStorage();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –∞–≤–∞—Ç–∞—Ä–∞
    const avatarInput = document.getElementById('avatarInput');
    avatarInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const avatarImg = document.getElementById('avatarImg');
          avatarImg.src = e.target.result;
          avatarImg.style.display = 'block';
          document.querySelector('.avatar-stub').style.display = 'none';
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≤–∞—Ç–∞—Ä –≤ localStorage
          saveAvatarToStorage(e.target.result);
        };
        reader.readAsDataURL(file);
      }
    });
  });

  // --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ---
  const settingsBtn = document.getElementById('settingsButton');
  const settingsModal = document.getElementById('settingsModal');
  const modalClose = document.getElementById('modalClose');
  const modalClose2 = document.getElementById('modalClose2');
  const accountManageBtn = document.getElementById('accountManageBtn');
  const accountManagePage = document.getElementById('accountManagePage');
  const settingsMainPage = document.getElementById('settingsMainPage');
  const backToSettingsBtn = document.getElementById('backToSettingsBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const deleteAccountBtn = document.getElementById('deleteAccountBtn');

  // --- –õ–æ–≥–∏–∫–∞ —Å–º–µ–Ω—ã –Ω–∏–∫–∞ –≤ –º–æ–¥–∞–ª–∫–µ ---
  const changeNickBtn = document.getElementById('changeNickBtn');
  const changeNicknamePage = document.getElementById('changeNicknamePage');
  const backToSettingsNickBtn = document.getElementById('backToSettingsNickBtn');
  const modalNicknameInput = document.getElementById('modalNicknameInput');
  const modalProfileForm = document.getElementById('modalProfileForm');
  const modalSaveMsg = document.getElementById('modalSaveMsg');

  if (changeNickBtn) {
    changeNickBtn.addEventListener('click', () => {
      settingsMainPage.style.display = 'none';
      changeNicknamePage.style.display = 'flex';
      modalNicknameInput.focus();
    });
  }
  if (backToSettingsNickBtn) {
    backToSettingsNickBtn.onclick = () => {
      changeNicknamePage.style.display = 'none';
      settingsMainPage.style.display = '';
      modalProfileForm.style.display = ''; // Reset form display
      modalSaveMsg.classList.remove('visible'); // Hide save message
      modalNicknameInput.value = ''; // Clear input
    };
  }

  if (modalProfileForm && modalNicknameInput && modalSaveMsg) {
    modalProfileForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const newNick = modalNicknameInput.value.trim();
      if (newNick) {
        document.getElementById('userName').textContent = newNick;
        modalSaveMsg.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
        modalSaveMsg.classList.add('visible');
        setTimeout(() => {
          modalSaveMsg.classList.remove('visible');
          // Do not hide the form, allow user to continue editing or go back
        }, 1200);
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∏–∫–∞ –≤ localStorage –∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      }
    });
  }

  if (settingsBtn && settingsModal) {
    settingsBtn.addEventListener('click', () => {
      settingsModal.style.display = 'flex';
      settingsMainPage.style.display = '';
      accountManagePage.style.display = 'none';
      changeNicknamePage.style.display = 'none'; // Ensure nickname page is hidden initially
    });
  }
  if (modalClose) modalClose.onclick = () => settingsModal.style.display = 'none';
  if (modalClose2) modalClose2.onclick = () => settingsModal.style.display = 'none';
  if (document.getElementById('modalCloseNick')) document.getElementById('modalCloseNick').onclick = () => settingsModal.style.display = 'none';
  if (accountManageBtn) accountManageBtn.onclick = () => {
    settingsMainPage.style.display = 'none';
    accountManagePage.style.display = '';
  };
  if (backToSettingsBtn) backToSettingsBtn.onclick = () => {
    accountManagePage.style.display = 'none';
    settingsMainPage.style.display = '';
  };
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
  settingsModal.addEventListener('mousedown', e => {
    if (e.target === settingsModal) settingsModal.style.display = 'none';
  });
  // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
  if (logoutBtn) {
    logoutBtn.onclick = () => {
      window.location.href = 'index.html';
    };
  }
  // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
  if (deleteAccountBtn) {
    deleteAccountBtn.onclick = () => {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) {
        window.location.href = 'index.html';
      }
    };
  }

  // –ö–ª–∏–∫ –ø–æ –ª–æ–≥–æ—Ç–∏–ø—É –≤—Å–µ–≥–¥–∞ –≤–µ–¥—ë—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é
  document.getElementById('mainLogo').onclick = () => window.location.href = 'index.html';

  function parseDiceFormula(formula) {
    const match = formula.match(/(\d*)d(\d+)([+-]\d+)?/i);
    if (!match) return null;
    const count = parseInt(match[1] || '1', 10);
    const die = parseInt(match[2], 10);
    const mod = match[3] ? parseInt(match[3], 10) : 0;
    return { count, die, mod };
  }
  function showDiceModal() {
    let modal = document.getElementById('fantasy-dice-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'fantasy-dice-modal';
      modal.style.position = 'fixed';
      modal.style.left = 0;
      modal.style.top = 0;
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.35)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = 2000;
      modal.innerHTML = `
        <div class="fantasy-modal-content" style="min-width: 340px; text-align: center; position: relative; padding: 36px 48px; border-radius: 22px; box-shadow: 0 6px 32px 0 rgba(80,60,20,0.18);">
          <h2 class="fantasy-modal-title" style="font-family: 'Uncial Antiqua', serif; font-size: 2em; margin-bottom: 18px;"><i class="fa-solid fa-dice-d20"></i> –ë—Ä–æ—Å–æ–∫ –∫–æ—Å—Ç–∏</h2>
          <div style="margin-bottom: 12px;">
            <select id="dice-type" style="font-size:1.1em;padding:6px 12px;border-radius:8px;">
              <option value="d4">d4</option>
              <option value="d6">d6</option>
              <option value="d8">d8</option>
              <option value="d10">d10</option>
              <option value="d12">d12</option>
              <option value="d20" selected>d20</option>
              <option value="d100">d100</option>
            </select>
            <input id="dice-count" type="number" min="1" max="20" value="1" style="width:48px;font-size:1.1em;margin-left:8px;border-radius:8px;padding:6px;">
            <input id="dice-mod" type="number" value="0" style="width:48px;font-size:1.1em;margin-left:8px;border-radius:8px;padding:6px;">
          </div>
          <div style="margin-bottom: 8px;">–∏–ª–∏ —Ñ–æ—Ä–º—É–ª–∞: <input id="dice-formula" type="text" placeholder="2d6+3" style="width:90px;font-size:1.1em;border-radius:8px;padding:6px;"></div>
          <div id="dice-result" style="font-size: 1.5em; margin-bottom: 18px;">üé≤</div>
          <button id="roll-again" class="fantasy-btn" style="margin-bottom:12px;"><i class="fa-solid fa-dice"></i> –ë—Ä–æ—Å–∏—Ç—å</button><br>
          <button id="close-dice-modal" class="fantasy-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      `;
      document.body.appendChild(modal);
      const rollAgainBtn = modal.querySelector('#roll-again');
      const closeDiceModalBtn = modal.querySelector('#close-dice-modal');
      const diceTypeSelect = modal.querySelector('#dice-type');
      const diceCountInput = modal.querySelector('#dice-count');
      const diceModInput = modal.querySelector('#dice-mod');
      const diceFormulaInput = modal.querySelector('#dice-formula');
      const diceResult = modal.querySelector('#dice-result');
      function roll() {
        let formula = diceFormulaInput.value.trim();
        if (!formula) {
          const type = diceTypeSelect.value;
          const count = parseInt(diceCountInput.value, 10) || 1;
          const mod = parseInt(diceModInput.value, 10) || 0;
          formula = `${count}${type}${mod ? (mod > 0 ? '+' + mod : mod) : ''}`;
        }
        const parsed = parseDiceFormula(formula);
        if (!parsed) {
          diceResult.textContent = '–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º—É–ª—ã';
          return;
        }
        let total = 0;
        let rolls = [];
        for (let i = 0; i < parsed.count; i++) {
          const val = Math.floor(Math.random() * parsed.die) + 1;
          rolls.push(val);
          total += val;
        }
        total += parsed.mod;
        diceResult.textContent = `${rolls.join(' + ')}${parsed.mod ? (parsed.mod > 0 ? ' + ' : ' - ') + Math.abs(parsed.mod) : ''} = ${total}`;
      }
      rollAgainBtn.onclick = roll;
      closeDiceModalBtn.onclick = () => modal.remove();
      diceTypeSelect.onchange = () => { diceFormulaInput.value = ''; };
      diceCountInput.oninput = () => { diceFormulaInput.value = ''; };
      diceModInput.oninput = () => { diceFormulaInput.value = ''; };
      diceFormulaInput.oninput = () => {};
      modal.addEventListener('mousedown', (e) => {
        if (e.target === modal) modal.remove();
      });
    }
  }
  const fabDice = document.getElementById('diceFabBtn');
  if (fabDice) fabDice.onclick = showDiceModal;
</script>
</body>
</html> 